(function(){var t={},n=function(){!function(t){var n;t._getCtx=function(){if(!n){var t=document.createElement("canvas");n=t.getContext("2d")}return n},t.calcObjSizes=function(t){for(var n=this.createIteratorFor(t.words),e=null;e=n.next();){var i=this.textLength(e.text+" ",t);e.w=i,e.h=t.fontSize}return t},t.createIteratorFor=function(t){var n=0,e=0,i={start:function(){n=0,e=0},next:function(){var r=t[n];if(!r)return null;if(r.length<=e)return n++,e=0,i.next();var a=e++;return r[a]},prev:function(){if(0>=e)return 0>=n?null:(n--,e=t[n].length,i.prev());var r=t[n];return e--,r[e]}};return i},t.fontStyleString=function(t){var n=Math.floor(t.fontSize)+"px "+t.fontFamily;return t.italic&&(n="italic "+n),t.bold&&(n="bold "+n),n},t.prepareLines=function(t){var n=this.createIteratorFor(t.words);t._lines=[],t._lineHeight=[],t._lineCnt=0,t._hOverFlow=0;var e=t.w,i=(t.h,0),r=0,a=0,l=0,o=0,f=(t.lineStep||4,t.wordStep||0),s=function(n){o=0,r=0,i=0;for(var s=null,h=function(n,e,i){t._lines[n]?i&&(t._lines[n].length=0):t._lines[n]=[],t._lines[n].push(e)};s=n.next();){if(0==o)s.h>a&&(a=s.h),h(i,s,!0),r+=s.w+f,r>t.w&&(t._hOverFlow=r-t.w),s._lineIndex=i,s._total=r,t._lineCnt=i+1,o++;else{var _=r+s.w+f;_>=e?(o=1,i++,h(i,s,!0),r=s.w+f,r>t.w&&(t._hOverFlow=r-t.w),l+=a,s._total=r,s._lineIndex=i,t._lineCnt=i+1):(r+=s.w+f,s._lineIndex=i,s._total=r,h(i,s),t._lineCnt=i+1,o++)}s._newline&&(o=0,i++,r=0,l+=a)}for(var c=0;c<t._lineCnt;c++)t._lineHeight[c]=0;for(n.start();s=n.next();){var c=s._lineIndex;t._lineHeight[c]<s.h&&(t._lineHeight[c]=s.h)}};s(n);for(var h=0,_=0;_<t._lineCnt;_++)h+=t._lineHeight[_];return h+=(t.lineStep||5)*t._lineCnt},t.renderPage=function(t,n,e){var i=t._lineCnt,r=0,a=0,l=5;t.x&&(r+=t.x),t.y&&(r+=t.y),t.lineStep&&(l=t.lineStep);var o=r;e?(n.textBaseline("bottom"),n.font(this.fontStyleString(t))):(n.textBaseline="bottom",n.font=this.fontStyleString(t));for(var f=0;i>f;f++){var s=t._lineHeight[f],h=t._lines[f];r=o;var _=0;"center"==t.align&&(r+=(t.w-h[h.length-1]._total)/2),"right"==t.align&&(r+=t.w-h[h.length-1]._total),"fill"==t.align&&h.length>1&&(_=(t.w-h[h.length-1]._total)/(h.length-1)),_>.2*t.width&&(_=0),f==i-1&&(_=0),h.length>0&&h[h.length-1]._newline&&(_=0);for(var c=0;c<h.length;c++){var u=h[c];n.fillText(u.text,r,a+s),n.strokeText(u.text,r,a+s),r+=u.w+_}a+=t._lineHeight[f]+l}},t.renderText=function(t,n,e){var i=this.txtToObjs(t,n),r=(this.calcObjSizes(i),n.fontSize);if(n.fitToPage){var a=10,l=0,o=4,f=t.length,s=this.prepareLines(i),h=r,_=1,c=Math.sqrt(n.w*n.h/f);c>n.h&&(c=n.h);var u=this,v=function(t){h=t,i.fontSize=h,u.calcObjSizes(i),s=u.prepareLines(i),l=s-n.h};for(v(c);a>0&&Math.abs(l)>1;){var w=Math.sqrt(n.w*s/f);o||(o=Math.abs(w-c)),n.h<s?h-=o*_:h+=o*_,v(h),a--,_-=.04}for(a=20;a>0&&l>=0;)h-=1,v(h),a--;i._hOverFlow&&(i.fontSize=.9*h*(i.w/(i.w+i._hOverFlow)),this.calcObjSizes(i),s=this.prepareLines(i)),l=s-n.h,i._autoFontSize=h}else this.prepareLines(i);this.renderPage(i,e),i.fontSize=r},t.renderText2=function(t,n,e){{var i=this.txtToObjs(t,n);this.calcObjSizes(i)}this.prepareLines(i),this.renderPage(i,e,!0)},t.textLength=function(t,n){var e=this._getCtx();return e.font=this.fontStyleString(n),e.measureText(t).width},t.txtToObjs=function(t,n){var e=t.split("\n");return n||(n={words:[]}),n.words||(n.words=[]),n.words.length=0,e.forEach(function(t){var e=t.split(" "),i=[],r=0;if(e.forEach(function(t){var n=t;if(n.length>0){var e={text:n,_i:r++};i.push(e)}}),0==i.length){var a={text:"",_i:r++};i.push(a)}i.length>0&&(i[r-1]._newline=!0,n.words.push(i))}),n}}(this),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},e=function(t,n,i,r,a,l,o,f){var s,h=this;if(!(h instanceof e))return new e(t,n,i,r,a,l,o,f);var _=[t,n,i,r,a,l,o,f];if(h.__factoryClass)if(h.__factoryClass.forEach(function(t){s=t.apply(h,_)}),"function"==typeof s){if(s._classInfo.name!=e._classInfo.name)return new s(t,n,i,r,a,l,o,f)}else if(s)return s;h.__traitInit?h.__traitInit.forEach(function(t){t.apply(h,_)}):"function"==typeof h.init&&h.init.apply(h,_)};e._classInfo={name:"canvasUtils"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());