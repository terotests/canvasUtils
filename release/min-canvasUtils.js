(function(){var t={},n=function(){!function(t){var n;t._getCtx=function(){if(!n){var t=document.createElement("canvas");n=t.getContext("2d")}return n},t.calcObjSizes=function(t){for(var n=this.createIteratorFor(t.words),e=null;e=n.next();){var i=this.textLength(e.text+" ",t);e.w=i,e.h=t.fontSize}return t},t.createIteratorFor=function(t){var n=0,e=0,i={start:function(){n=0,e=0},next:function(){var r=t[n];if(!r)return null;if(r.length<=e)return n++,e=0,i.next();var l=e++;return r[l]},prev:function(){if(0>=e)return 0>=n?null:(n--,e=t[n].length,i.prev());var r=t[n];return e--,r[e]}};return i},t.fontStyleString=function(t){var n=Math.floor(t.fontSize)+"px "+t.fontFamily;return t.italic&&(n="italic "+n),t.bold&&(n="bold "+n),n},t.prepareLines=function(t){var n=this.createIteratorFor(t.words);t._lines=[],t._lineHeight=[],t._lineCnt=0,t._hOverFlow=0;var e=t.w,i=(t.h,0),r=0,l=0,a=0,o=0,s=(t.lineStep||4,t.wordStep||0),f=function(n){o=0,r=0,i=0;for(var f=null,h=function(n,e,i){t._lines[n]?i&&(t._lines[n].length=0):t._lines[n]=[],t._lines[n].push(e)};f=n.next();){if(0==o)f.h>l&&(l=f.h),h(i,f,!0),r+=f.w+s,r>t.w&&(t._hOverFlow=r-t.w),f._lineIndex=i,f._total=r,t._lineCnt=i+1,o++;else{var u=r+f.w+s;u>=e?(o=1,i++,h(i,f,!0),r=f.w+s,r>t.w&&(t._hOverFlow=r-t.w),a+=l,f._total=r,f._lineIndex=i,t._lineCnt=i+1):(r+=f.w+s,f._lineIndex=i,f._total=r,h(i,f),t._lineCnt=i+1,o++)}f._newline&&(o=0,i++,r=0,a+=l)}for(var _=0;_<t._lineCnt;_++)t._lineHeight[_]=0;for(n.start();f=n.next();){var _=f._lineIndex;t._lineHeight[_]<f.h&&(t._lineHeight[_]=f.h)}};f(n);for(var h=0,u=0;u<t._lineCnt;u++)h+=t._lineHeight[u];return h+=(t.lineStep||5)*t._lineCnt},t.renderPage=function(t,n,e){var i=t._lineCnt,r=0,l=0,a=5;t.x&&(r+=t.x),t.y&&(r+=t.y),t.lineStep&&(a=t.lineStep);var o=r;e?(n.textBaseline("bottom"),n.font(this.fontStyleString(t))):(n.textBaseline="bottom",n.font=this.fontStyleString(t));for(var s=0;i>s;s++){var f=t._lineHeight[s],h=t._lines[s];r=o;var u=0;"center"==t.align&&(r+=(t.w-h[h.length-1]._total)/2),"right"==t.align&&(r+=t.w-h[h.length-1]._total),"fill"==t.align&&h.length>1&&(u=(t.w-h[h.length-1]._total)/(h.length-1)),u>.2*t.width&&(u=0),s==i-1&&(u=0),h.length>0&&h[h.length-1]._newline&&(u=0);for(var _=0;_<h.length;_++){var c=h[_];n.fillText(c.text,r,l+f),n.strokeText(c.text,r,l+f),r+=c.w+u}l+=t._lineHeight[s]+a}},t.renderText=function(t,n,e){var i=this.txtToObjs(t,n),r=(this.calcObjSizes(i),n.fontSize);if(n.fitToPage){var l=10,a=0,o=4,s=t.length,f=this.prepareLines(i),h=r,u=1,_=Math.sqrt(n.w*n.h/s);_>n.h&&(_=n.h);var c=this,v=function(t){h=t,i.fontSize=h,c.calcObjSizes(i),f=c.prepareLines(i),a=f-n.h};for(v(_);l>0&&Math.abs(a)>1;){var p=Math.sqrt(n.w*f/s);o||(o=Math.abs(p-_)),n.h<f?h-=o*u:h+=o*u,v(h),l--,u-=.04}for(l=20;l>0&&a>=0;)h-=1,v(h),l--;i._hOverFlow&&(i.fontSize=.9*h*(i.w/(i.w+i._hOverFlow)),this.calcObjSizes(i),f=this.prepareLines(i)),a=f-n.h,i._autoFontSize=h}else this.prepareLines(i);this.renderPage(i,e),i.fontSize=r},t.renderText2=function(t,n,e){{var i=this.txtToObjs(t,n);this.calcObjSizes(i)}this.prepareLines(i),this.renderPage(i,e,!0)},t.textLength=function(t,n){var e=this._getCtx();return e.font=this.fontStyleString(n),e.measureText(t).width},t.txtToObjs=function(t,n){var e=t.split("\n");return n||(n={words:[]}),n.words||(n.words=[]),n.words.length=0,e.forEach(function(t){var e=t.split(" "),i=[],r=0;if(e.forEach(function(t){var n=t;if(n.length>0){var e={text:n,_i:r++};i.push(e)}}),0==i.length){var l={text:"",_i:r++};i.push(l)}i.length>0&&(i[r-1]._newline=!0,n.words.push(i))}),n}}(this),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},e=function(t,n,i,r,l,a,o,s){var f,h=this;if(!(h instanceof e))return new e(t,n,i,r,l,a,o,s);var u=[t,n,i,r,l,a,o,s];if(h.__factoryClass)if(h.__factoryClass.forEach(function(t){f=t.apply(h,u)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,l,a,o,s)}else if(f)return f;h.__traitInit?h.__traitInit.forEach(function(t){t.apply(h,u)}):"function"==typeof h.init&&h.init.apply(h,u)};e._classInfo={name:"canvasUtils"},e.prototype=new n,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.canvasUtils=e,this.canvasUtils=e):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.canvasUtils=e:this.canvasUtils=e}.call(new Function("return this")()),"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());